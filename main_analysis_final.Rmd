---
title: 'EldersAIR: Main analysis - final version and manuscript results'
author: "Ethan Walker"
date: "Started 16 April 2021; Updated 16 April 2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, include = TRUE,
                      message = FALSE, warning = FALSE)
```

```{r}
library(readxl)
library(naniar)
library(lubridate)
library(emmeans)
library(broom)
library(broom.mixed)
library(zoo)
library(car)
library(lme4)
library(lmerTest)
library(mctest)
library(tidyverse)
library(knitr)
library(kableExtra)
#library(MASS)
library(faraway)
library(splines)
library(influence.ME)
```

```{r}
# Load data

file_path <- c("C:/Users/ethan.walker/Box/Ethan Walker UM/R/EldersAIR/")

treatments_blind_nn <- read_xlsx(paste0(file_path, "Input/NN/treatments_blind.xlsx")) %>% 
  mutate(area = "NN")

treatments_blind_npt <- read_xlsx(paste0(file_path, "Input/NP/treatments_blind.xlsx")) %>% 
  mutate(area = "NPT")

treatments_blind <- rbind(treatments_blind_nn, treatments_blind_npt) %>% 
  mutate(home_id_num = as.factor(HomeID),
         treatment_blind = as.factor(CodedCondition),
         area = as.factor(area)) %>% 
  select(area, home_id_num, treatment_blind)

elders_cleaned_dataset_by_visit <- read_rds(paste0(file_path, "Output/elders_cleaned_dataset_by_visit.rds")) %>% 
  left_join(treatments_blind, by = c("area", "home_id_num")) 
```


```{r}
## select outcome variable
### bp_sys, bp_dia, fvc, fev1, fev1_fvc_ratio, fvc_pp, fev1_pp, pm_mean_visit
analysis_data <- elders_cleaned_dataset_by_visit %>% 
  mutate(treatment = factor(treatment,
                            levels = c("Placebo", "Filter", "Education"),
                            labels = c("Placebo", "Filter", "Education")),
         visit_intervention_diff = round(difftime(sampling_date, intervention_date, 
                                            units = "days"), digits = 0),
         visit_intervention_diff = as.numeric(visit_intervention_diff),
         visit_intervention_diff = if_else(winter_id == 1, 9999,
                                           visit_intervention_diff)) %>% 
  filter(spiro_status == "Acceptable") %>%  # only use this filter for spiro outcomes
  mutate(outcome = fev1)  # select outcome here

  
analysis_data_2row <- analysis_data %>% 
  arrange(area, home, adult_id_char, winter_id, sampling_visit) %>% 
  group_by(area, home, adult_id_char, winter_id) %>% 
  mutate(outcome = if_else(winter_id == 1, mean(outcome, na.rm = T), outcome)) %>% 
  dplyr::select(area, home, adult_id_char, winter_id, sampling_visit, 
                cohort, treatment_blind, treatment, outcome,
                visit_intervention_diff) %>% 
  group_by(area, adult_id_char) %>% 
  pivot_wider(names_from = "winter_id", values_from = "outcome") %>% 
  arrange(area, home, adult_id_char, sampling_visit) %>% 
  mutate(outcome = `2`,
         baseline_outcome = `1`,
         baseline_outcome = if_else(is.na(baseline_outcome), first(baseline_outcome),
                                    baseline_outcome)) %>% 
  replace_with_na(replace = list(baseline_outcome = NaN, outcome = NaN)) %>% 
  filter(visit_intervention_diff != 9999) %>% 
  ungroup()


#table(analysis_data$area, analysis_data$treatment_blind)
#table(analysis_data$area, analysis_data$cohort)
```


# ITT Model Code - Data formatted as 2 rows per person  
outcome = outcome from Winter 2 visits (up to 2 repeated measures)  
baseline_outcome = mean outcome from Winter 1  
Two ways of dealing with/looking at time since intervention:  
   visit_intervention_diff is days since intervention; included as numeric covariate  
   sampling_visit designates Visit 1 or Visit 2 of Winter 2; included as interaction term  
```{r, echo=T}
itt_health_results_2row <- lmer(outcome ~ treatment + 
                                baseline_outcome + (1 | adult_id_char:home:cohort:area), 
                                data = analysis_data_2row)


isSingular(itt_health_results_2row)

summary(itt_health_results_2row)

tidy_results_2row <- tidy(itt_health_results_2row, conf.int = TRUE) %>% 
  mutate(group_filter = if_else(grepl("treatment", term), 1, 0)) %>% 
  filter(group_filter == 1) %>% 
  mutate(term = gsub("treatment_blind", "", term)) %>% 
  mutate(estimate = round((estimate), digits = 2),
         conf.low = round((conf.low), digits = 2),
         conf.high = round((conf.high), digits = 2)) %>% 
  dplyr::select(term, estimate, conf.low, conf.high, p.value) %>% 
  mutate(term = gsub("treatment", "", term),
         model = "2-row") %>% 
  dplyr::select(-p.value)
tidy_results_2row


plot(itt_health_results_2row, main = "ITT Primary Model", 
     xlab = "fitted values", ylab = "residuals")
qqnorm(residuals(itt_health_results_2row), main = "ITT Primary Model")
qqline(residuals(itt_health_results_2row))
```


# ITT primary model identify potential influential datapoints
```{r}
influential <- influence(itt_health_results_2row, obs = TRUE)
cooks <- cooks.distance.estex(influential, sort = TRUE)
plot.estex(influential, which = "cook")

# bp_sys: try removing lines 127, 202, 95, 32, 48, 31, 17, 216, 128, 4
# bp_dia: try removing lines 42, 95, 192, 127, 48, 202, 191, 31, 223, 7
# fvc: try removing lines 93, 94, 34, 82, 35, 164, 142, 81, 219, 32
# fev1: try removing lines 79, 34, 24, 80, 25, 82, 26, 230, 5, 6
# fev1_fvc_ratio: try removing lines
# fvc_pp: try removing lines
# fev1_pp: try removing lines
```


# ITT Effect modification model code
```{r}
itt_health_results_2row_int <- lmer(outcome ~ treatment_blind*sampling_visit + 
                                    baseline_outcome + (1 | adult_id_char:home:cohort:area), 
                                    data = analysis_data_2row)
```

