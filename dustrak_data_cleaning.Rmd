---
title: "EldersAIR initial PM data work"
author: "Ethan Walker"
date: "Started 12 Feb 2020, Updated 14 Feb 2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(tidyverse)
library(readxl)
library(naniar)
library(lubridate)
library(zoo)
library(knitr)
jv_palette <- c("#330099","#CC0066","#FF6633", 
                 "#0099CC", "#FF9900","#CC6633",
                  "#FF3366", "#33CC99", "#33999")
```


# Load, format, and save DustTrak log file for NP
```{r}
## Box location: Update Box location once final data loaded
np_dustrack_initial <- read_csv("Input/NP/np_dustrack_20200214.csv") %>% 
  # rename variables
  mutate(home_winter_id = as.factor(HomeWinterID),
         dtid = as.factor(DTID),
         start_date_pm = mdy(StartDate),
         start_time_pm = as.character(StartTime),
         stop_date_pm = mdy(StopDate),
         stop_time_pm = as.character(StopTime),
         sample_obs = as.numeric(DTLength),
         sample_ave = as.numeric(DTAverage),
         sample_min = as.numeric(DTMin),
         sample_max = as.numeric(DTMax),
         pm_comments = as.character(Comments),
         sampling_visit = as.factor(SamplingVisit),
         area = "NP") %>% 
  select(home_winter_id, area, dtid, sampling_visit, start_date_pm, start_time_pm,
         stop_date_pm, stop_time_pm, sample_obs, sample_ave, sample_min,
         sample_max, pm_comments) %>% 
  arrange(home_winter_id)
#write_rds(np_dustrack_initial, "Output/np_dustrack.rds")
```


# Initial load, format, and save EldersAIR DustTrak (PM) data
## Files were downloaded from Box: NoonanGroupData > EldersAIR
```{r}
##### Read in dusttrack .txt files #####


### NN ###
# List files
list_text_files <- list.files("Input/NN/nn_dustrak/pre_20200218/text")

# Set working directory and load files in list; extract file name and add as column
## run next 4 lines together
setwd("Input/NN/nn_dustrak/pre_20200218/text") # set new working directory
initial_data = tibble(file_name = list_text_files) %>% # use list of files from above
  mutate(save_data = lapply(file_name, read_delim, delim = " ", skip = 28)) %>%
  unnest(save_data)


# Format combined file from above; combine with other PM data below
nn_pm_text_space <- initial_data %>% 
  separate(file_name, c("home", "trash"), sep = 7, remove = FALSE) %>% 
  mutate(home = as.character(home),
         date_pm = mdy(`MM/dd/yyyy`),
         time_pm = as.character(`hh:mm:ss`),
         pm = as.numeric(`mg/m^3`),
         area = "NN",
         file_type = "text") %>% 
  unite("datetime", c("date_pm", "time_pm"), sep = " ", remove = FALSE) %>% 
  mutate(datetime_pm = ymd_hms(datetime)) %>% 
  select(home, area, datetime_pm, date_pm, time_pm, pm, file_type) %>% 
  filter(!is.na(pm)) %>% 
  ungroup() %>% 
  arrange(area, home, datetime_pm)



# Set working directory and load files in list; extract file name and add as column
## run next 4 lines together
setwd("Input/NN/nn_dustrak/pre_20200218/text") # set new working directory
initial_data = tibble(file_name = list_text_files) %>% # use list of files from above
  mutate(save_data = lapply(file_name, read_delim, delim = ",", skip = 28)) %>%
  unnest(save_data)


# Format combined file from above; combine with other PM data below
nn_pm_text_comma <- initial_data %>% 
  separate(file_name, c("home", "trash"), sep = 7, remove = FALSE) %>% 
  mutate(home = as.character(home),
         date_pm = mdy(`MM/dd/yyyy`),
         time_pm = as.character(`hh:mm:ss`),
         pm = as.numeric(`mg/m^3`),
         area = "NN",
         file_type = "text") %>% 
  unite("datetime", c("date_pm", "time_pm"), sep = " ", remove = FALSE) %>% 
  mutate(datetime_pm = ymd_hms(datetime)) %>% 
  select(home, area, datetime_pm, date_pm, time_pm, pm, file_type) %>% 
  filter(!is.na(pm)) %>% 
  ungroup() %>% 
  arrange(area, home, datetime_pm)



### NP ###
# List files
list_text_files <- list.files("Input/NP/np_dustrak/pre_20200218/text")

# Set working directory and load files in list; extract file name and add as column
## run next 4 lines together
setwd("Input/NP/np_dustrak/pre_20200218/text") # set new working directory
initial_data = tibble(file_name = list_text_files) %>% # use list of files from above
  mutate(save_data = lapply(file_name, read_delim, delim = ",", skip = 29,
                            col_names = c("date", "time", "pm"))) %>%
  unnest(save_data)


# Format combined file from above; combine with other PM data below
np_pm_text_comma <- initial_data %>% 
  separate(file_name, c("home", "trash"), sep = 7, remove = FALSE) %>% 
  mutate(home = as.character(home),
         date_pm = mdy(date),
         time_pm = as.character(time),
         pm = as.numeric(pm),
         area = "NP",
         file_type = "text") %>% 
  unite("datetime", c("date_pm", "time_pm"), sep = " ", remove = FALSE) %>% 
  mutate(datetime_pm = ymd_hms(datetime)) %>% 
  select(home, area, datetime_pm, date_pm, time_pm, pm, file_type) %>% 
  filter(!is.na(pm)) %>% 
  ungroup() %>% 
  arrange(area, home, datetime_pm)




##### Read in dusttrack .csv files #####


### NN ###
# List files
list_csv_files <- list.files("Input/NN/nn_dustrak/pre_20200218/csv")

# Set working directory and load files in list; extract file name and add as column
## run next 4 lines together
setwd("Input/NN/nn_dustrak/pre_20200218/csv") # set new working directory
initial_data = tibble(file_name = list_csv_files) %>% # use list of files from above
  mutate(save_data = lapply(file_name, read_csv)) %>%
  unnest(save_data)

# Format combined file from above; combine with other PM data below
nn_pm_csv <- initial_data %>% 
  mutate(trash1 = `Instrument Name`,
         trash2 = `DustTrak II`) %>% 
  select(file_name, trash1, trash2) %>% 
  group_by(file_name) %>% 
  mutate(date = if_else(trash1 == "Test Start Date", trash2,"NA"),
         time = if_else(trash1 == "Test Start Time", trash2,"NA")) %>% 
  arrange(date, time) %>% 
  mutate(time = lead(time),
         date = first(date),
         time = first(time),
         elapsed_time = as.numeric(trash1)) %>% 
  filter(!is.na(elapsed_time)) %>% 
  #separate(time, c("time", "trash3"), sep = " ") %>% 
  unite(datetime, c("date", "time"), sep = " ") %>% 
  mutate(pm = as.numeric(trash2),
         datetime = mdy_hms(datetime),
         datetime_pm = datetime + seconds(elapsed_time)) %>% 
  separate(datetime_pm, c("date", "time_pm"), sep = " ", remove = FALSE) %>% 
  mutate(date_pm = ymd(date),
         area = "NN",
         file_type = "csv") %>% 
  ungroup() %>% 
  separate(file_name, c("home", "trash"), sep = 7, remove = FALSE) %>% 
  select(home, area, datetime_pm, date_pm, time_pm, pm, file_type) %>% 
  filter(!is.na(pm)) %>% 
  arrange(area, home, datetime_pm)


### NP ###
# List files
list_csv_files <- list.files("Input/NP/np_dustrak/pre_20200218/csv")

# Set working directory and load files in list; extract file name and add as column
## run next 4 lines together
setwd("Input/NP/np_dustrak/pre_20200218/csv") # set new working directory
initial_data = tibble(file_name = list_csv_files) %>% # use list of files from above
  mutate(save_data = lapply(file_name, read_csv)) %>%
  unnest(save_data)

# Format combined file from above; combine with other PM data below
np_pm_csv <- initial_data %>% 
  mutate(trash1 = `Instrument Name`,
         trash2 = `DustTrak II`) %>% 
  select(file_name, trash1, trash2) %>% 
  group_by(file_name) %>% 
  mutate(date = if_else(trash1 == "Test Start Date", trash2,"NA"),
         time = if_else(trash1 == "Test Start Time", trash2,"NA")) %>% 
  arrange(date, time) %>% 
  mutate(time = lead(time),
         date = first(date),
         time = first(time),
         elapsed_time = as.numeric(trash1)) %>% 
  filter(!is.na(elapsed_time)) %>% 
  #separate(time, c("time", "trash3"), sep = " ") %>% 
  unite(datetime, c("date", "time"), sep = " ") %>% 
  mutate(pm = as.numeric(trash2),
         datetime = mdy_hms(datetime),
         datetime_pm = datetime + seconds(elapsed_time)) %>% 
  separate(datetime_pm, c("date", "time_pm"), sep = " ", remove = FALSE) %>% 
  mutate(date_pm = ymd(date),
         area = "NP",
         file_type = "csv") %>% 
  ungroup() %>% 
  separate(file_name, c("home", "trash"), sep = 7, remove = FALSE) %>% 
  select(home, area, datetime_pm, date_pm, time_pm, pm, file_type) %>% 
  filter(!is.na(pm)) %>% 
  arrange(area, home, datetime_pm)




##### Bind files from above #####
elders_pm <- rbind(nn_pm_csv, nn_pm_text_comma, nn_pm_text_space,
                   np_pm_csv, np_pm_text_comma) %>% 
  arrange(area, home, datetime_pm) %>% 
  ungroup()
# Save pm dataset as RDS 
# write_rds(elders_pm, "Output/elders_pm_full_raw.rds")
```

# Initial cleaning steps
## Remember to add correction factor
```{r}
elders_pm_full_raw <- read_rds("Output/elders_pm_full_raw.rds")

elders_pm_new <- elders_pm_full_raw %>%  
  #filter(area == "AK") %>% 
  # apply correction factor to pm and change to ug
  mutate(pm = pm/1.65,
         pm = pm*1000) %>% 
  mutate(pm = as.numeric(pm),
         day_of_week = weekdays(date_pm))


# write_rds(elders_pm_new, "Output/elders_pm_clean.rds")
```

