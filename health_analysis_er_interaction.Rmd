---
title: 'EldersAIR: ER Interaction Analysis for Health Outcomes'
author: "Ethan Walker"
date: "Started 20 May 2022; Updated 20 May 2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, include = TRUE,
                      message = FALSE, warning = FALSE)
```

```{r}
library(readxl)
library(naniar)
library(lubridate)
library(emmeans)
library(broom)
library(broom.mixed)
library(zoo)
library(car)
library(lme4)
library(lmerTest)
library(mctest)
library(tidyverse)
library(knitr)
library(kableExtra)
#library(MASS)
library(faraway)
library(splines)
library(influence.ME)
library(sjstats)
```

```{r}
# Load data

file_path <- c("C:/Users/ethan.walker/Box/Ethan Walker UM/R/EldersAIR/")

analysis_data <- read_rds(paste0(file_path, "Output/elders_cleaned_dataset_by_visit.rds")) 
```

# Indoor/Area PM2.5 Interaction Analysis
```{r}
## select outcome variable
### bp_sys, bp_dia, fvc, fev1, fev1_fvc_ratio, fvc_pp, fev1_pp, pm_mean_visit
er_data_4row <- analysis_data %>% 
  #filter(spiro_status == "Acceptable") %>%  # only use this filter for spiro outcomes
  mutate(outcome = bp_sys,
         sampling_date_num = as.factor(sampling_date)) %>%  # select outcome here
  arrange(area, home, adult_id_char, winter_id, sampling_visit) %>% 
  group_by(area, home, adult_id_char, winter_id, sampling_visit) %>% 
  dplyr::select(area, home, adult_id_char, winter_id, sampling_visit, 
                cohort, treatment, outcome, income, education, residents_smoke, 
                home_sqm_2level, burn_level, gender, chimney_clean, stove_age, 
                stove_grade, age, bmi, visit_intervention_diff, 
                treatment_filter_type, filter_compliance, kw_perc_expected,
                burn_level_3level, chimney_clean_3level, age_2level,
                bmi_2level, income_2level, income_3level, stove_age_2level,
                hypertension, wood_collect_3level, home_year_built_2level,
                steps, steps_2level, steps_4level, sampling_date,
                home_floors_2level, wood_collect_method,
                pm_mean_visit, pm_mean_at_home_visit) %>% 
  mutate(pm_iqr = pm_mean_visit/32,
         pm_at_home_iqr = pm_mean_at_home_visit/32) %>% 
  ungroup() %>% 
  distinct(area, adult_id_char, winter_id, sampling_visit, .keep_all = T) 



# Function for area PM interaction analysis
int_function <- function(data, interaction_var, interaction_label) {
  
  new_model_data <- data %>% 
    rename(int_var = interaction_var)
  
  
# Run primary model and print results
er_results_int <<- lmer(outcome ~ log(pm_mean_visit)*int_var + ns(sampling_date, df = 4) + 
                         age + 
                         #gender + 
                         income + 
                         education + 
                         residents_smoke +
                         (1 | adult_id_char:home:cohort:area), 
                         data = new_model_data)

#write_rds(itt_results_int, paste0(file_path, "Output/itt_pm_results_int_age.rds"))


save_summary <<- summary(er_results_int)

int_emtrends <- emtrends(er_results_int, pairwise ~ int_var, var = "log(pm_mean_visit)")

summary(int_emtrends)

save_contrasts <<- confint(int_emtrends$emtrends) %>% 
  mutate(estimate = round(`log(pm_mean_visit).trend`, digits = 2),
         conf.low = round(lower.CL, digits = 2),
         conf.high = round(upper.CL, digits = 2)) %>% 
  dplyr::select(int_var, estimate, conf.low, conf.high)


plot_results <- save_contrasts %>% 
  ggplot() +
  geom_point(aes(x=int_var, y=estimate), 
             position = position_dodge(width = 0.5), size = 4) +
  geom_errorbar(aes(x=int_var, ymin=conf.low, ymax=conf.high), 
             position = position_dodge(width = 0.5), size = 1.2, width = 0.5) +
  geom_hline(yintercept = 1) +
  theme_bw() +  
  ggtitle(label = "Interaction contrasts, ER framework, SBP",
          subtitle = paste0("Interaction term = ", interaction_label)) +
  labs(y = "Difference") +
  labs(x = "", group = "", shape = "") +
  theme(title = element_text(size = 16), 
          axis.text.x = element_text(size = 16, colour = "black", angle = 45,
                                     hjust = 1, vjust = .8),
          axis.text.y = element_text(size = 16, colour = "black"),
          axis.title.y = element_text(size = 16,
                                      margin = margin(t = 0, r = 20, b = 0, l = 0)),
          axis.line.x = element_line(colour = "black", size = 1.2), 
          axis.line.y = element_line(colour = "black", size = 1.2), 
          axis.ticks = element_blank(), 
          panel.border = element_blank(), 
          panel.grid = element_blank(),
          legend.position = "top",
          legend.text = element_text(size = 14, colour = "black")) 


plot_results 

}


# Run interaction function for the following variables:
#int_function(pm_data_2row, "area", "Study area") # need to remove random effect in model
int_function(er_data_4row, "home_floors_2level", "Floors in home")
int_function(er_data_4row, "home_sqm_2level", "Home Square Meters")
int_function(er_data_4row, "education", "Education")
int_function(er_data_4row, "income_2level", "Income")
int_function(er_data_4row, "home_year_built_2level", "Year home was built")
int_function(er_data_4row, "stove_age_2level", "Stove age")
int_function(er_data_4row, "stove_grade", "Stove grade")
int_function(er_data_4row, "chimney_clean_3level", "When was chimney cleaned")
int_function(er_data_4row, "wood_collect_3level", "When was wood collected")
int_function(er_data_4row, "wood_collect_method", "Wood collect method")
int_function(er_data_4row, "burn_level_3level", "Burn level")
int_function(er_data_4row, "residents_smoke", "Residents Smoke")
int_function(er_data_4row, "age_2level", "Resident Age")
int_function(er_data_4row, "gender", "Resident Gender")


# Use the following lines to help fill in information for publication tables:
obs <- bp_sys_data_2row %>% 
  filter(!is.na(outcome)) %>% 
  filter(!is.na(baseline_outcome)) %>%
  filter(!is.na(area)) %>% 
  filter(!is.na(cohort)) %>% 
  filter(!is.na(treatment)) %>% 
  filter(!is.na(gender)) %>%
  group_by(gender, treatment) %>% 
  count()
obs
save_contrasts
Anova(itt_results_int)


n_table
pm_summary_table
save_summary
save_contrasts_full
```
